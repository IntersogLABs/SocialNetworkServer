define([
  'views/base/collection-view',
  'text!templates/posts/posts-collection-view.hbs',
  'text!templates/posts/edit-form.hbs',
  './post-view'
], function(CollectionView, template, editForm, PostItemView) {
  'use strict';

  var PostsCollectionView = CollectionView.extend({
    autoRender: true,
    itemView: PostItemView,
    template: template,
    listSelector: ".list-group",
    fallbackSelector: ".fallback",
    loadingSelector: ".loading",
    animationDuration: 0,

    events: {
        "click #close":"deletePost",
        "click #send":"addPost",
        "click #transform":"transformPost",
        "click #Edit":"editPost",
        "click #Cancel":"cancel"
      },

      cancel: function() {
        this.collection.fetch().then(function(){ this.render() }.bind(this));
      },

      transformPost: function(data) {        
        var id = $(data.target).parent().siblings('button.close').children().attr("data-id")
        var parent= $(data.target).parent().parent();
        var value = $(data.target).parent().siblings('p.list-group-item-text').text();

        $(data.target).parent().siblings('p').remove();

        $(data.target).parent().remove();

        var templ = Handlebars.compile(editForm);
        parent.append(templ);

        parent.find('textarea').val(value);
        $("#Edit").attr('data-id',id)
      },

      editPost: function(data) {
        var url="http://localhost:100/posts/"+$(data.target).attr("data-id"); 
        $.ajax({url:url,
          method:"PUT",
          data: JSON.stringify({
            content:$(data.target).siblings('textarea').val()
          }),
          success:function(res) {
            this.collection.fetch().then(function(){ this.render() }.bind(this));
          }.bind(this)
        });
      },

      deletePost: function(data) {
        var url="http://localhost:100/posts/"+$(data.target).attr("data-id"); 
        $.ajax({url:url,
          method:"DELETE",
          success: function() {
            $(data.target).parentsUntil("ul").remove();
          }});
      },

      addPost: function(data) {
        $.ajax({url:"http://localhost:100/user/"+config.currentUserId+"/wall",
          method:"POST",
          data:JSON.stringify({
            content:$('textarea').val()
          }),
          success:function(res) {
            this.collection.fetch().then(function(){ this.render() }.bind(this));
          }.bind(this)
        })
      },

  });

  return PostsCollectionView;
});
